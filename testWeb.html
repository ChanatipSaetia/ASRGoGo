<!DOCTYPE html>
<html lang="en">

<head>
  <title>{{ title }}</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/style.css">

  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/component.css" />
</head>

<body>

  <img src="src/bg.jpg" style="opacity: 0.4; z-index:-1; width:auto; max-height: 100wh; position: absolute; top:0; bottom: 0; left: 0; right: 0; margin: auto; -webkit-filter: brightness(90%) blur(11px);">
  <div class="container">
    <input type="checkbox" id="btn" onclick="startTri(); decision(this);"/>
    <label for="btn"></label>
    <div class="time">
      <div class="h_m"></div>
      <div class="s_ms"></div>
    </div>
  </div>

  <div class="govageeheader"><p style="opacity: 100%; margin-top: 16px; z-index: 99999;">govajee</p></div>

  <div id="large-header" class="large-header">
    <canvas id="demo-canvas"
      style="z-index: 99;
      bottom: 0;
	    margin: 0px 0px 0px 0px;">
    </canvas>
  </div>

  <div class="log-report" style="overflow: hidden;  width: 450px; z-index:70;">
    <ul id="recordingslist"></ul>
    <pre id="log" style="overflow-y: scroll;"></pre>
  </div>
  <!-- script zone-->
  <script src="http://code.responsivevoice.org/responsivevoice.js"></script>
  <script type="text/javascript">
            var pp = 0.8 + 1.0*Math.random();
            if(Math.random() < 0.5) responsiveVoice.speak("โกวาจีไงเย่เย่เย่", "Thai Female" , {pitch: pp}, {rate: 1.7});
            else responsiveVoice.speak("หวัดดีแจ้", "Thai Female" , {pitch: pp}, {rate: 1.7});</script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
  <script src="recorder.js"></script>

  <script src="js/TweenLite.min.js"></script>
  <script src="js/EasePack.min.js"></script>
  <script src="js/rAF.js"></script>
  <script src="js//demo-3.js"></script>
  <script>
    function __log(e, data) {
      log.innerHTML += (data || '') + '\n\n';
      var myDiv = $("#log").get(0);
      myDiv.scrollTop = myDiv.scrollHeight;
    }

    var audio_context;
    var recorder;
    var rec = false;

    function startUserMedia(stream) {
      var input = audio_context.createMediaStreamSource(stream);
      // __log('Media stream created.');

      // Uncomment if you want the audio to feedback directly
      //input.connect(audio_context.destination);
      //__log('Input connected to audio context destination.');

      recorder = new Recorder(input);
      // __log('Recorder initialised.');
    }

    function decision(button) {
      if (rec===false) {
        rec = true;
        startRecording(button);
      } else if(rec === true){
        rec = false;
        stopRecording(button);
      }
    }

    function startRecording(button) {
      recorder && recorder.record();
    }

    function stopRecording(button) {
      recorder && recorder.stop();

      // create WAV download link using audio data blob
      createDownloadLink();

      recorder.clear();
    }

    function createDownloadLink() {
      recorder && recorder.exportWAV(function(blob) {
        var formData = new FormData();
        formData.append("filearg", blob);
        var request = new XMLHttpRequest();
        request.open("POST", "/test");
        request.onload = function(oEvent) {
          if (request.status == 200) {
            __log(0,request.response);
            responsiveVoice.speak(request.response, "Thai Female");
          } else {
            __log(1,"โกวาจีกำลังเอ๋อง่ะ<div style=\"margin-top: -5px; font-size: 0.6em; font-weight: 200; color: #666; position:absolute;\">ERROR CODE " + request.status + "</div>");
            var xxxxx = Math.random();
            if(xxxxx < 0.33) responsiveVoice.speak("พูดอะไรของเธอน่ะ", "Thai Female" , {pitch: pp}, {rate: 1.7});
            else if(xxxxx > 0.66) responsiveVoice.speak("บ่นบ่นบ่น", "Thai Female" , {pitch: pp}, {rate: 1.7});
            else responsiveVoice.speak("งงค่ะ", "Thai Female" , {pitch: pp}, {rate: 1.7});
          }
        };

        request.send(formData);
      });
    }

    window.onload = function init() {
      try {
        // webkit shim
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia;
        window.URL = window.URL || window.webkitURL;

        audio_context = new AudioContext;
        // __log('Audio context set up.');
        // __log('navigator.getUserMedia ' + (navigator.getUserMedia ? 'available.' : 'not present!'));
      } catch (e) {
        alert('No web audio support in this browser!');
      }

      navigator.getUserMedia({
        audio: true
      }, startUserMedia, function(e) {
        // __log('No live audio input: ' + e);
      });
    }

    function scrollToBottom(id){
      var div = document.getElementById(id);
      div.scrollTop = div.scrollHeight - div.clientHeight;
    }


    ////////////////////////////////////////////////////////

    var width, height, largeHeader, canvas, ctx, triangles, target, animateHeader = true;
    var colors = ['255,100,224', '100,183,225', '118,245,100', '244,105,102', '141,102,245' ,
     '253,225,119', '255,255,255', '128,222,250'];
    var sw = -90;
    var toggle = false;
    var aph = 0.5;
    var neww = true;

    function startTri(){
        if(toggle === false && neww){
            toggle = true;
            aph = 0.5;
            neww = false;
            initHeader();
            addListeners();
            initAnimation();
        } else if(toggle === false && !neww){
            aph = 0.5;
            toggle = true;
        } else {toggle = false; aph = 0;}
        console.log(toggle);
    }

    function initHeader() {
        width = window.innerWidth;
        height = window.innerHeight;
        target = {x: 0, y: height};

        largeHeader = document.getElementById('large-header');
        largeHeader.style.height = height+'px';

        canvas = document.getElementById('demo-canvas');
        canvas.width = width;
        canvas.height = height;
        ctx = canvas.getContext('2d');

        // create particles
        triangles = [];
        for(var x = 0; x < 400; x++) {
            addTriangle(x*30);
        }
    }

    function addTriangle(delay) {
        setTimeout(function() {
            var t = new Triangle();
            triangles.push(t);
            tweenTriangle(t);
        }, delay);
    }

    function initAnimation() {
        animate();
    }

    function tweenTriangle(tri) {
        var t = Math.random()*(2*Math.PI);
        var x = (200+Math.random()*100)*Math.cos(t) + width*0.5;
        var y = (200+Math.random()*100)*Math.sin(t) + height+sw;
        var time = 10+4*Math.random();

        TweenLite.to(tri.pos, time, {x: x,
            y: y, ease:Circ.easeOut,
            onComplete: function() {
                tri.init();
                tweenTriangle(tri);
        }});
    }

    // Event handling
    function addListeners() {
        window.addEventListener('scroll', scrollCheck);
        window.addEventListener('resize', resize);
    }

    function scrollCheck() {
        if(document.body.scrollTop > height) animateHeader = false;
        else animateHeader = true;
    }

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        largeHeader.style.height = height+'px';
        canvas.width = width;
        canvas.height = height;
    }

    function animate() {
        if(animateHeader) {
            ctx.clearRect(0,0,width,height);
            for(var i in triangles) {
                triangles[i].draw();
            }
        }
        requestAnimationFrame(animate);
    }

    // Canvas manipulation
    function Triangle() {
        var _this = this;

        // constructor
        (function() {
            _this.coords = [{},{},{}];
            _this.pos = {};
            init();
        })();

        function init() {
            _this.pos.x = width*0.5;
            _this.pos.y = height+sw;
            _this.scale = 0.1+Math.random()*0.5;
            _this.color = colors[Math.floor(Math.random()*colors.length)];
            setTimeout(function() { _this.alpha = aph; }, 5);
        }

        this.draw = function() {
            if(_this.alpha >= 0.005) _this.alpha -= 0.005;
            else _this.alpha = 0;
            ctx.beginPath();
            ctx.arc(_this.pos.x, _this.pos.y, _this.scale*30, 0, 2 * Math.PI, false);
            ctx.fillStyle = 'rgba('+_this.color+','+ _this.alpha+')';
            ctx.fill();
        };

        this.init = init;
    }
  </script>
</body>

</html>
